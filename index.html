<html>
    <head>
        <title>Game of Life</title>
        <script>
            window.addEventListener('DOMContentLoaded', (event) => {
                let renderBoardButton = document.getElementById('renderBoardButton');
                let nextStateButton = document.getElementById('nextState');
                let runGameButton = document.getElementById('runGame');
                let stopGameButton = document.getElementById('stopGame');

                let state;
                let runningGameInterval;

                renderBoardButton.addEventListener('click', function(event) {
                    event.preventDefault();
                    let boardHeight = document.getElementById('boardHeight').value;
                    let boardWidth = document.getElementById('boardWidth').value;
                    let board = document.getElementById('board');
                    board.style.setProperty('--board-rows', boardWidth);
                    board.style.setProperty('--board-cols', boardHeight);
                    
                    state = getRandomState(boardWidth, boardHeight);
                    outputState(state);

                    nextStateButton.disabled = false;
                    runGameButton.disabled = false;
                });
                nextStateButton.addEventListener('click', function(event) {
                    event.preventDefault();
                    state = getNextState(state);
                    outputState(state);
                });
                runGameButton.addEventListener('click', function(event) {
                    event.preventDefault();
                    nextStateButton.disabled = true;
                    runningGameInterval = setInterval(
                        () => {
                            state = getNextState(state);
                            outputState(state);
                            if (isDeadState(state)) {
                                clearInterval(runningGameInterval);
                                stopGameButton.style.display = 'none';
                                runGameButton.style.display = 'inline';
                            }
                        }
                        , 1000);
                    runGameButton.style.display = 'none';
                    stopGameButton.style.display = 'inline';
                });
                stopGameButton.addEventListener('click', function(event) {
                    event.preventDefault();
                    clearInterval(runningGameInterval);
                    stopGameButton.style.display = 'none';
                    runGameButton.style.display = 'inline';
                    nextStateButton.disabled = false;
                });
            });

            function getDeadState(width=5, height=5) {
                let state = new Array(height);
                for (let y = 0; y < height; y++) {
                    state[y] = new Array(width);
                    for (let x = 0; x < width; x++) {
                        state[y][x] = 0;
                    }
                }
                return state;
            }

            function getRandomState(width=5, height=5) {
                let state = getDeadState(width, height);
                for (let x = 0; x < width; x++) {
                    for (let y = 0; y < height; y++) {
                        state[y][x] = Math.floor(Math.random() * 2);
                    }
                }
                return state;
            }

            function cloneState(state) {
                const newState = [...state];
                newState.forEach((row, rowIndex) => newState[rowIndex] = [...row]);
                return newState;
            }

            function isDeadState(state) {
                // TODO: redo simpler
                let stateSum = state.reduce((prevRow, curRow) => prevRow.concat(curRow)).reduce((prevCell, curCell) => prevCell + curCell)
                if (stateSum == 0)
                    return true;
                else
                    return false;
            }

            function getNextState(state) {
                let newState = cloneState(state);
                let height = state.length;
                let width = state[0].length;
                let neighbourhoodType = document.getElementById('neighbourhoodType').value;

                for (let y = 0; y < height; y++) {
                    for (let x = 0; x < width; x++) {
                        let numNeighbours = getNeighbours(x, y, state, neighbourhoodType);

                        if (state[y][x] == 1) {
                            if (numNeighbours <= 1 || numNeighbours > 3)
                                newState[y][x] = 0;
                            else
                                newState[y][x] = 1;
                        } else if (state[y][x] === 0 && numNeighbours === 3) {
                            newState[y][x] = 1;
                        }
                    }
                }
                return newState;
            }

            function getNeighbours(centralCellX, centralCellY, state, neighbourhoodType = 'moore') {
                let numNeighbours = 0;
                let height = state.length;
                let width = state[0].length;

                if (neighbourhoodType == 'moore') {
                    for (let neighbourCellY = centralCellY - 1; neighbourCellY < centralCellY + 2; neighbourCellY++) {
                        if (neighbourCellY < 0 || neighbourCellY >= height)
                            continue;
                        for (let neighbourCellX = centralCellX - 1; neighbourCellX < centralCellX + 2; neighbourCellX++) {
                            if (neighbourCellX < 0 || neighbourCellX >= width)
                                continue;
                            if (neighbourCellX == centralCellX && neighbourCellY == centralCellY)
                                continue;
                            numNeighbours += state[neighbourCellY][neighbourCellX];
                        }
                    }
                } else if (neighbourhoodType == 'neumann') {
                    for (let neighbourCellY = centralCellY - 2; neighbourCellY < centralCellY + 3; neighbourCellY++) {
                        if (neighbourCellY < 0 || neighbourCellY >= height)
                            continue;
                        numNeighbours += state[neighbourCellY][centralCellX];
                    }
                    for (let neighbourCellX = centralCellX - 2; neighbourCellX < centralCellX + 3; neighbourCellX++) {
                        if (neighbourCellX < 0 || neighbourCellX >= width || neighbourCellX == centralCellX)
                            continue;
                        numNeighbours += state[centralCellY][neighbourCellX];
                    }
                }
                return numNeighbours;
            }

            function outputState(state) {
                let board = document.getElementById('board');
                board.innerHTML = '';

                for (let y = 0; y < state.length; y++) {
                    for (let x = 0; x < state[0].length; x++) {
                        let cell = document.createElement('div');
                        cell.dataset.col = y;
                        cell.dataset.row = x;
                        cell.addEventListener('drop', function(event) {
                            event.preventDefault();
                            let patternType = event.dataTransfer.getData('patternType');
                            loadPattern(x, y, state, patternType);
                        });
                        cell.addEventListener('dragover', function(event) {
                            event.preventDefault();
                        });
                        cell.addEventListener('dragenter', function(event) {
                            event.target.classList.add('cell-hover');
                        });
                        cell.addEventListener('dragleave', function(event) {
                            event.target.classList.remove('cell-hover');
                        });
                        if (state[y][x] == 1)
                            cell.className = 'cell cell-alive';
                        else
                            cell.className = 'cell cell-dead';
                        cell.onclick = () => {
                            if (state[y][x] == 1)
                                state[y][x] = 0;
                            else
                                state[y][x] = 1;
                            
                            outputState(state);
                            return false;
                        }
                        board.appendChild(cell);
                    }
                }
            }

            function drag(event) {
                event.dataTransfer.setData('patternType', event.target.id)
            }

            function loadPattern(targetPositionX, targetPositionY, state, patternType) {
                let boardHeight = state.length;
                let boardWidth = state[0].length;
                let patterns = {};
                patterns['patternToad'] = [
                    [0, 1, 1, 1],
                    [1, 1, 1, 0]
                ];
                patterns['patternBlinker'] = [
                    [1],
                    [1],
                    [1]
                ];
                patterns['patternBeacon'] = [
                    [1, 1, 0, 0],
                    [1, 1, 0, 0],
                    [0, 0, 1, 1],
                    [0, 0, 1, 1]
                ];
                patterns['patternGlider'] = [
                    [0, 0, 1],
                    [1, 0, 1],
                    [0, 1, 1]
                ];
                pattern = patterns[patternType];
                if (!pattern) {
                    console.error('No pattern found with ID: ', patternType);
                    return;
                }
                patternHeight = pattern.length;
                patternWidth = pattern[0].length;
                for (let y = 0; y < patternHeight; y++) {
                    if (y + targetPositionY >= boardHeight)
                        continue;
                    for (let x = 0; x < patternWidth; x++) {
                        if (x + targetPositionX >= boardWidth)
                            continue;
                        state[y + targetPositionY][x + targetPositionX] = pattern[y][x]; 
                    }
                }
                outputState(state);
            }


            function nextStateTests() {
                // TODO: Move to Jest
                let testInitState1 = [
                    [0,0,0],
                    [0,0,0],
                    [0,0,0]
                ];
                let testNextState1 = [
                    [0,0,0],
                    [0,0,0],
                    [0,0,0]
                ];
                nextStateUnitTest(testInitState1, testNextState1, 'Test 1 Failed');
                let testInitState2 = [
                    [0,0,1],
                    [0,1,1],
                    [0,0,0]
                ];
                let testNextState2 = [
                    [0,1,1],
                    [0,1,1],
                    [0,0,0]
                ];
                nextStateUnitTest(testInitState2, testNextState2, 'Test 2 Failed');
            }
            function nextStateUnitTest(initState, nextState, message) {
                console.log('Testing:: Init:', initState, ' Expected:', nextState, ' Actual:', getNextState(initState));
                console.assert(JSON.stringify(getNextState(initState)) == JSON.stringify(nextState), message);
            }
        </script>
        <style>
            #board {
                font-family: 'Courier New', Courier, monospace;
            }

            :root {
                --board-cols: 1;
                --board-rows: 1;
            }

            #board {
                width: 40%;
                display: grid;
                /* grid-gap: 1em; */
                grid-template-rows: repeat(var(--board-rows), 1fr);
                grid-template-columns: repeat(var(--board-cols), 1fr);
            }
            #stopGame {
                display: none;
            }

            .cell {
                padding: 0em;
                border: 1px solid rgb(235, 235, 235);
                text-align: center;
                aspect-ratio: 1;
            }
            .cell-dead {
                background-color: white;
            }
            .cell-alive {
                background-color: rgb(129, 129, 129);
            }
            .cell-hover {
                background-color: rgb(201, 76, 38);
            }

        </style>
    </head>
    <body>
        <h1>Conway's Game of Life</h1>
        <form>
            <label for="boardWidth">Width</label> <input type="number" id="boardWidth" value="5" />
            <label for="boardHeight">Height</label> <input type="number" id="boardHeight" value="5" />
            <label for="neighbourhoodType">Neighbourhood Type: </label>
            <select id="neighbourhoodType" name="neighbourhoodType">
                <option value="moore">Moore</option>
                <option value="neumann">von Neumann</option>
            </select>
            <button id="renderBoardButton" accesskey="r">Render <u>R</u>andom Board</button> 
            <button id="nextState" accesskey="n" disabled><u>N</u>ext State</button>
            <button id="runGame" accesskey="g" disabled>Run <u>G</u>ame</button>
            <button id="stopGame" accesskey="g">Stop <u>G</u>ame</button>
            <div id="patterns">Patterns (Drag 'n Drop): <a id="patternToad" draggable="true" ondragstart="drag(event)">Toad</a> <a id="patternBeacon" draggable="true" ondragstart="drag(event)">Beacon</a> <a id="patternBlinker" draggable="true" ondragstart="drag(event)">Blinker</a> <a id="patternGlider" draggable="true" ondragstart="drag(event)">Glider</a></div>
        </form>
        <div id="board">

        </div>
    </body>
</html>
<!-- 
    TODO:
    Add dead new board button
    Add unit tests for von Neumann + Moore neighbourhoods
 -->