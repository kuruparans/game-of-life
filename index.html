<html>
    <head>
        <title>Game of Life</title>
        <script>
            window.addEventListener('DOMContentLoaded', (event) => {
                let renderBoardButton = document.getElementById('renderBoardButton');
                let nextStateButton = document.getElementById('nextState');
                let boardHeight, boardWidth, state;
                renderBoardButton.onclick = function() {
                    boardHeight = document.getElementById('boardHeight').value;
                    boardWidth = document.getElementById('boardWidth').value;
                    let board = document.getElementById('board');
                    board.style.setProperty('--board-rows', boardWidth);
                    board.style.setProperty('--board-cols', boardHeight);
                    
                    state = getRandomState(boardWidth, boardHeight);
                    outputState(state);
                    nextStateButton.disabled = false;
                    return false;
                }
                nextStateButton.onclick = function() {
                    state = getNextState(state);
                    outputState(state);
                    return false;
                }
            });

            function makeRows(rows, cols) {
                let board = document.getElementById('board');
                board.style.setProperty('--board-rows', rows);
                board.style.setProperty('--board-cols', cols);
                for (let c = 0; c < (rows * cols); c++) {
                    let cell = document.createElement("div");
                    cell.innerText = (c + 1);
                    container.appendChild(cell).className = "grid-item";
                }
            }

            function startScript() {
                boardState = [
                    [1,1,1,1,1,1,1],
                    [1,1,1,1,1,1,1],
                    [1,1,1,1,1,1,1],
                    [1,1,1,1,1,1,1],
                    [1,0,1,1,1,1,1],
                    [1,1,1,1,1,1,1]
                ];
                console.log(boardState);
                return boardState;
            }

            function loadState(initialState) {
                let toad = [
                    [0,0,0,0,0,0],
                    [0,0,0,0,0,0],
                    [0,0,1,1,1,0],
                    [0,1,1,1,0,0],
                    [0,0,0,0,0,0],
                    [0,0,0,0,0,0]
                ];
                let beacon = [];
                let blinker = [];
                let glider = [];
                let gospelGliderGun = [];
            }


            function getDeadState(width=5, height=5) {
                let state = new Array(height);
                for (let y = 0; y < height; y++) {
                    state[y] = new Array(width);
                    for (let x = 0; x < width; x++) {
                        state[y][x] = 0;
                    }
                }
                return state;
            }

            function getRandomState(width=5, height=5) {
                let state = getDeadState(width, height);
                for (let x = 0; x < width; x++) {
                    for (let y = 0; y < height; y++) {
                        state[y][x] = Math.floor(Math.random() * 2);
                    }
                }
                return state;
            }

            function cloneState(state) {
                const newState = [...state];
                newState.forEach((row, rowIndex) => newState[rowIndex] = [...row]);
                return newState;
            }

            function getNextState(state) {
                let newState = cloneState(state);
                let height = state.length;
                let width = state[0].length;
                for (let y = 0; y < height; y++) {
                    for (let x = 0; x < width; x++) {
                        let numNeighbours = getNeighbours(x, y, state);

                        if (state[y][x] == 1) {
                            if (numNeighbours <= 1 || numNeighbours >= 3)
                                newState[y][x] = 0;
                            else
                                newState[y][x] = 1;
                        } else if (state[y][x] === 0 && numNeighbours === 3) {
                            newState[y][x] = 1;
                        }
                    }
                }
                return newState;
            }

            function getNeighbours(x, y, state) {
                let numNeighbours = 0;
                let height = state.length;
                let width = state[0].length;
                for (let y_position = y - 1; y_position < y + 2; y_position++) {
                    if (y_position < 0 || y_position >= height)
                        continue;
                    for (let x_position = x - 1; x_position < x + 2; x_position++) {
                        if (x_position < 0 || x_position >= width)
                            continue;
                        if (x_position == x && y_position == y)
                            continue;
                        numNeighbours += state[y_position][x_position];
                    }
                }
                return numNeighbours;
            }

            function outputState(state) {
                let board = document.getElementById('board');
                board.innerHTML = '';

                for (let y = 0; y < state.length; y++) {
                    for (let x = 0; x < state[0].length; x++) {
                        let cell = document.createElement('div');
                        cell.dataset.col = y;
                        cell.dataset.row = x;
                        if (state[y][x] == 1)
                            cell.className = 'cell cell-alive'
                        else
                            cell.className = 'cell cell-dead'
                        board.appendChild(cell);
                    }
                }
            }

            function nextStateTests() {
                // TODO: Move to Jest
                let testInitState1 = [
                    [0,0,0],
                    [0,0,0],
                    [0,0,0]
                ];
                let testNextState1 = [
                    [0,0,0],
                    [0,0,0],
                    [0,0,0]
                ];
                nextStateUnitTest(testInitState1, testNextState1, 'Test 1 Failed');
                let testInitState2 = [
                    [0,0,1],
                    [0,1,1],
                    [0,0,0]
                ];
                let testNextState2 = [
                    [0,1,1],
                    [0,1,1],
                    [0,0,0]
                ];
                nextStateUnitTest(testInitState2, testNextState2, 'Test 2 Failed');
            }
            function nextStateUnitTest(initState, nextState, message) {
                console.log('Testing:: Init:', initState, ' Expected:', nextState, ' Actual:', getNextState(initState));
                console.assert(JSON.stringify(getNextState(initState)) == JSON.stringify(nextState), message);
            }
        </script>
        <style>
            #board {
                font-family: 'Courier New', Courier, monospace;
            }

            :root {
                --board-cols: 1;
                --board-rows: 1;
            }

            #board {
                width: 50%;
                display: grid;
                /* grid-gap: 1em; */
                grid-template-rows: repeat(var(--board-rows), 1fr);
                grid-template-columns: repeat(var(--board-cols), 1fr);
            }

            .cell {
                padding: 0em;
                border: 1px solid rgb(235, 235, 235);
                text-align: center;
                aspect-ratio: 1;
            }
            .cell-dead {
                background-color: white;
            }
            .cell-alive {
                background-color: rgb(129, 129, 129);
            }

        </style>
    </head>
    <body>
        <form>
            <label for="boardWidth">Width</label> <input type="number" id="boardWidth" value="5" />
            <label for="boardHeight">Height</label> <input type="number" id="boardHeight" value="5" />
            <button id="renderBoardButton" accesskey="r">Render <u>R</u>andom Board</button> 
            <button id="nextState" accesskey="n" disabled><u>N</u>ext State</button>
        </form>
        <div id="board">

        </div>
    </body>
</html>
<!-- 
    TODO:
    Play/stop button - infinite loop
    Add option for von Neumann Neighbourhood scoring vs Moore
    Add option to load other items
    Add option to edit grid by clicking on square
 -->